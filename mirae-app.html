<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mirae - Growth Companion</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React and ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  
  <!-- Babel Standalone for JSX transformation -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    /* Custom animations */
    @keyframes fade-in {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slide-in-from-bottom {
      from { transform: translateY(10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes slide-in-from-right {
      from { transform: translateX(20px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slide-in-from-left {
      from { transform: translateX(-10px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes zoom-in {
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    .animate-in {
      animation: fade-in 0.3s ease-out;
      animation-fill-mode: forwards;
    }
    .fade-in { 
      animation: fade-in 0.3s ease-out;
      animation-fill-mode: forwards;
    }
    .slide-in-from-bottom-4 { 
      animation: slide-in-from-bottom 0.7s ease-out;
      animation-fill-mode: forwards;
    }
    .slide-in-from-right-8 { 
      animation: slide-in-from-right 0.5s ease-out;
      animation-fill-mode: forwards;
    }
    .slide-in-from-bottom-2 { 
      animation: slide-in-from-bottom 0.3s ease-out;
      animation-fill-mode: forwards;
    }
    .slide-in-from-left-4 { 
      animation: slide-in-from-left 0.4s ease-out;
      animation-fill-mode: forwards;
    }
    .slide-in-from-right-4 { 
      animation: slide-in-from-right 0.4s ease-out;
      animation-fill-mode: forwards;
    }
    .zoom-in-95 { 
      animation: zoom-in 0.7s ease-out;
      animation-fill-mode: forwards;
    }
    
    /* Prevent animations from re-triggering on re-render */
    .animate-in,
    .fade-in,
    .slide-in-from-bottom-4,
    .slide-in-from-right-8,
    .slide-in-from-bottom-2,
    .slide-in-from-left-4,
    .slide-in-from-right-4,
    .zoom-in-95 {
      animation-iteration-count: 1;
    }
    
    /* Prevent flash on state changes - only animate elements that haven't been animated */
    .no-animate {
      animation: none !important;
    }
    
    /* Selection color */
    ::selection {
      background-color: #e0e7ff;
    }
    
    /* Icon SVG styles */
    .icon-svg {
      display: inline-block;
      vertical-align: middle;
    }
    
    /* Prevent scroll jumping on input focus */
    .chat-messages-container {
      scroll-behavior: smooth;
      overscroll-behavior: contain;
    }
    
    .chat-input-container {
      position: sticky;
      bottom: 0;
      z-index: 10;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useMemo, useCallback } = React;

    // Simple icon component using Lucide SVG paths
    // For a full implementation, you'd load lucide-react, but for simplicity we'll use Unicode/Emoji fallbacks
    const Icon = ({ name, size = 24, className = '' }) => {
      const iconMap = {
        'arrow-right': '‚Üí',
        'sparkles': '‚ú®',
        'book-open': 'üìñ',
        'plus': '+',
        'x': '√ó',
        'fingerprint': 'üëÜ',
        'loader-2': '‚ü≥',
        'anchor': '‚öì',
        'message-circle': 'üí¨',
        'lightbulb': 'üí°',
        'globe': 'üåê',
        'eye-off': 'üëÅÔ∏è'
      };
      
      return (
        <span className={`icon-svg ${className}`} style={{ fontSize: size, width: size, height: size, display: 'inline-flex', alignItems: 'center', justifyContent: 'center' }}>
          {iconMap[name] || '‚Ä¢'}
        </span>
      );
    };

    // --- SIMULATION SYSTEM ---
    // Simulates AI responses based on user context and selections
    
    const simulateResponse = async (context, chatHistory, userMessage, lang) => {
      // Add a small delay to simulate thinking
      await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 1200));
      
      const isKorean = lang === 'ko';
      const signals = context.signals || [];
      const state = context.state;
      const year = context.year;
      
      // Initial greeting based on context
      if (chatHistory.length === 0) {
        const greetings = isKorean ? [
          `ÏïàÎÖï! ${year}ÌïôÎÖÑÏù¥Íµ¨ÎÇò. ÎÑ§Í∞Ä Ï†ÅÏñ¥Ï§Ä ÏãúÍ∑∏ÎÑêÎì§ÏùÑ Î≥¥ÎãàÍπå ${signals.length > 0 ? signals.slice(0, 2).join('ÏôÄ ') + ' Í∞ôÏùÄ Í≤ÉÎì§Ïù¥' : 'ÎßéÏùÄ Í≤ÉÎì§Ïù¥'} ÎÑ§Í≤å ÏùòÎØ∏Í∞Ä ÏûàÍµ¨ÎÇò.`,
          `${year}ÌïôÎÖÑÏù¥ÎÑ§! ${signals.length > 0 ? signals[0] : 'ÎÑ§Í∞Ä ÏÑ†ÌÉùÌïú Í≤ÉÎì§'}ÏùÑ Î≥¥Î©¥ ÎÑ§Í∞Ä Î¨¥ÏóáÏùÑ ÏÜåÏ§ëÌûà Ïó¨Í∏∞ÎäîÏßÄ Ïïå Ïàò ÏûàÏùÑ Í≤É Í∞ôÏïÑ.`,
          `Î∞òÍ∞ÄÏõå! ${state === 'pre' ? 'ÏÑ†ÌÉùÏùÑ ÏïûÎëêÍ≥† ÏûàÎã§Îãà' : 'Ïù¥Í≤å ÎßûÎÇò Ïã∂ÏùÄ ÎßàÏùåÏù¥ ÏûàÎã§Îãà'} ÏßÄÍ∏à Ïù¥ ÏàúÍ∞ÑÏù¥ ÎÑ§Í≤å Ï§ëÏöîÌïú ÏãúÍ∞ÑÏù¥Í≤†Íµ¨ÎÇò.`
        ] : [
          `Hi! You're in Grade ${year}. Looking at your signals like ${signals.length > 0 ? signals.slice(0, 2).join(' and ') : 'the things you chose'}, I can see what matters to you.`,
          `Grade ${year}! From ${signals.length > 0 ? signals[0] : 'your selections'}, I sense what you value deeply.`,
          `Welcome! ${state === 'pre' ? 'Facing a decision' : 'Feeling uncertain'} - this moment is important for you.`
        ];
        return greetings[Math.floor(Math.random() * greetings.length)];
      }
      
      // Response based on user message keywords and context
      const lowerMsg = userMessage.toLowerCase();
      const responses = [];
      
      // Context-aware responses
      if (signals.length > 0) {
        const signalMention = signals.find(s => lowerMsg.includes(s.toLowerCase()));
        if (signalMention) {
          responses.push(isKorean 
            ? `${signalMention}Ïóê ÎåÄÌï¥ ÎßêÌï¥Ï§òÏÑú Í≥†ÎßàÏõå. Í∑∏Í≤å ÎÑ§Í≤å Ïñ¥Îñ§ ÏùòÎØ∏Ïù∏ÏßÄ Îçî ÏûêÏÑ∏Ìûà Îì§Î†§Ï§Ñ Ïàò ÏûàÏùÑÍπå?`
            : `Thanks for sharing about ${signalMention}. Can you tell me more about what it means to you?`
          );
        }
      }
      
      // State-based responses
      if (state === 'pre' && (lowerMsg.includes('ÏÑ†ÌÉù') || lowerMsg.includes('decision') || lowerMsg.includes('choose'))) {
        responses.push(isKorean
          ? `ÏÑ†ÌÉùÏùÑ ÏïûÎëêÍ≥† ÏûàÏùÑ Îïå, Î¨¥ÏóáÏùÑ 'Ìï¥Ïïº' ÌïòÎäîÏßÄÎ≥¥Îã§ ÎÑ§Í∞Ä 'ÎàÑÍµ¨'Ïù∏ÏßÄÍ∞Ä Îçî Ï§ëÏöîÌï¥. ÎÑ§Í∞Ä Ïù¥ÎØ∏ Î≥¥Ïó¨Ï§Ä ÏãúÍ∑∏ÎÑêÎì§Ïù¥ ÎãµÏùò Ïã§ÎßàÎ¶¨Ïùº Í±∞Ïïº.`
          : `When facing a choice, who you are matters more than what you should do. The signals you've shown are clues to your answer.`
        );
      }
      
      if (state === 'doubt' && (lowerMsg.includes('Îßû') || lowerMsg.includes('right') || lowerMsg.includes('doubt'))) {
        responses.push(isKorean
          ? `ÏùòÏã¨ÏùÄ ÎÑ§Í∞Ä ÏßÑÏã¨ÏúºÎ°ú Í≥†ÎØºÌïòÍ≥† ÏûàÎã§Îäî Ï¶ùÍ±∞Ïïº. ÏôÑÎ≤ΩÌïú ÎãµÏùÑ Ï∞æÏúºÎ†§ ÌïòÍ∏∞Î≥¥Îã§, ÏßÄÍ∏à Ïù¥ ÏàúÍ∞Ñ ÎÑ§ ÎßàÏùåÏù¥ Ïñ¥ÎîîÎ°ú Ìñ•ÌïòÎäîÏßÄ ÎäêÍª¥Î¥ê.`
          : `Doubt shows you're thinking deeply. Instead of finding the perfect answer, feel where your heart is pointing right now.`
        );
      }
      
      // General reflective responses
      const generalResponses = isKorean ? [
        `Í∑∏Îü∞ ÎßàÏùåÏù¥ Îì§ Ïàò ÏûàÍ≤†Ïñ¥. Í∑∏ Í≤ΩÌóòÏù¥ ÎÑ§Í≤å Ïñ¥Îñ§ Í∞êÏ†ïÏùÑ Î∂àÎü¨ÏùºÏúºÏº∞Ïñ¥?`,
        `Ìù•ÎØ∏Î°≠ÎÑ§. Í∑∏Í≤å ÎÑ§Í≤å Ïñ¥Îñ§ ÏùòÎØ∏ÏòÄÎäîÏßÄ Îçî ÏûêÏÑ∏Ìûà Îì§Î†§Ï§Ñ Ïàò ÏûàÏùÑÍπå?`,
        `Í∑∏Îü∞ Ïù¥ÏïºÍ∏∞Î•º Îì§Î†§Ï§òÏÑú Í≥†ÎßàÏõå. Í∑∏ ÏàúÍ∞ÑÏóê ÎÑ§Í∞Ä Ïñ¥Îñ§ ÏÇ¨ÎûåÏù¥ÏóàÎäîÏßÄ ÏÉùÍ∞ÅÌï¥Î≥º Ïàò ÏûàÏùÑÍπå?`,
        `ÎÑ§Í∞Ä Í∑∏Î†áÍ≤å ÎäêÍºàÎã§Îäî Í≤å Ï§ëÏöîÌï¥. Í∑∏ Í≤ΩÌóòÏù¥ ÎÑ§Í≤å Î¨¥ÏóáÏùÑ ÏïåÎ†§Ï§¨ÏùÑÍπå?`,
        `Í∑∏Îü∞ Í≥†ÎØºÏùÑ ÌïòÍ≥† ÏûàÎã§Îãà ÎÑ§Í∞Ä ÏßÑÏã¨ÏúºÎ°ú ÏûêÏã†ÏùÑ ÌÉêÍµ¨ÌïòÍ≥† ÏûàÎã§Îäî ÎúªÏù¥Ïïº. Í≥ÑÏÜçÌï¥ÏÑú ÎÑ§ ÏïàÏùò Î™©ÏÜåÎ¶¨Î•º Îì§Ïñ¥Î¥ê.`
      ] : [
        `I can understand that feeling. What emotions did that experience bring up for you?`,
        `That's interesting. Can you tell me more about what it meant to you?`,
        `Thanks for sharing that. Can you think about who you were in that moment?`,
        `It's important that you felt that way. What did that experience teach you?`,
        `Having those thoughts shows you're truly exploring yourself. Keep listening to the voice inside you.`
      ];
      
      responses.push(...generalResponses);
      
      // Return a random response from the pool
      return responses[Math.floor(Math.random() * responses.length)];
    };
    
    const simulateTwin = async (context, chatHistory, lang) => {
      // Add a delay to simulate processing
      await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 1000));
      
      const isKorean = lang === 'ko';
      const signals = context.signals || [];
      const state = context.state;
      const year = context.year;
      
      // Generate archetype based on signals and state
      const archetypes = isKorean ? [
        "ÌÉêÍµ¨ÌïòÎäî Î≥Ñ", "ÏÑ±Ïû•ÌïòÎäî ÎÇòÎ¨¥", "ÍπäÏù¥ ÏÉùÍ∞ÅÌïòÎäî Î≥Ñ", "ÏûêÍ∏∞ Î∞úÍ≤¨Ïûê", "ÎÇ¥Î©¥Ïùò ÎÇòÏπ®Î∞ò"
      ] : [
        "Exploring Star", "Growing Tree", "Deep Thinker", "Self Discoverer", "Inner Compass"
      ];
      
      const archetype = archetypes[Math.floor(Math.random() * archetypes.length)];
      
      // Generate persona based on context
      const operatingManuals = isKorean ? [
        `ÎÑ§Í∞Ä ${signals.length > 0 ? signals.slice(0, 2).join('ÏôÄ ') : 'ÏÑ†ÌÉùÌïú Í≤ÉÎì§'}ÏùÑ ÌÜµÌï¥ ÏûêÏã†ÏùÑ Î∞úÍ≤¨ÌïòÎäî Ïó¨Ï†ïÏùÑ Í∞ÄÍ≥† ÏûàÏñ¥.`,
        `ÎÑ§ ÏïàÏùò Í∞ÄÏπòÎ•º Ï∞æÏïÑÍ∞ÄÎäî Í≥ºÏ†ïÏóêÏÑú ${state === 'pre' ? 'ÏÑ†ÌÉùÏùò ÏàúÍ∞Ñ' : 'ÏùòÏã¨Ïùò ÏàúÍ∞Ñ'}ÏùÑ Í≤™Í≥† ÏûàÍµ¨ÎÇò.`,
        `ÎÑ§Í∞Ä Î≥¥Ïó¨Ï§Ä ÏãúÍ∑∏ÎÑêÎì§Ïù¥ ÎÑ§ ÏßÑÏßú Î™®ÏäµÏùò Îã®ÏÑúÎì§Ïù¥Ïïº. Í∑∏Í≤ÉÎì§ÏùÑ ÎØøÍ≥† Îî∞ÎùºÍ∞ÄÎ¥ê.`
      ] : [
        `You're on a journey of self-discovery through ${signals.length > 0 ? signals.slice(0, 2).join(' and ') : 'your selections'}.`,
        `You're experiencing ${state === 'pre' ? 'a moment of choice' : 'a moment of doubt'} while finding your values.`,
        `The signals you've shown are clues to your true self. Trust them and follow them.`
      ];
      
      const fearRadars = isKorean ? [
        `ÎØ∏ÎûòÏóê ÎåÄÌïú Î∂àÏïà, ÏûòÎ™ªÎêú ÏÑ†ÌÉùÏóê ÎåÄÌïú ÎëêÎ†§ÏõÄ`,
        `Îã§Î•∏ ÏÇ¨ÎûåÏùò Í∏∞ÎåÄÏôÄ ÏûêÏã†Ïùò ÎßàÏùå ÏÇ¨Ïù¥Ïùò Í∞àÎì±`,
        `ÏôÑÎ≤ΩÌïú ÎãµÏùÑ Ï∞æÏßÄ Î™ªÌï† Í≤ÉÏóê ÎåÄÌïú Í±±Ï†ï`
      ] : [
        `Anxiety about the future, fear of making the wrong choice`,
        `Conflict between others' expectations and your own heart`,
        `Worry about not finding the perfect answer`
      ];
      
      const innerCompasses = isKorean ? [
        `ÎÑ§Í∞Ä ÏßÑÏã¨ÏúºÎ°ú Ï¢ãÏïÑÌïòÎäî Í≤ÉÎì§, Í∑∏Í≤ÉÎì§Ïù¥ ÎÑ§ Î∞©Ìñ•Ïù¥Ïïº`,
        `ÎÑ§Í∞Ä 'ÎÇòÎãµÎã§'Í≥† ÎäêÎÅºÎäî ÏàúÍ∞ÑÎì§, Í∑∏ Í∞êÍ∞ÅÏùÑ Ïã†Î¢∞Ìï¥`,
        `ÎÑ§ ÏïàÏùò Î™©ÏÜåÎ¶¨, Í∑∏Í≤ÉÏù¥ Í∞ÄÏû• Ï†ïÌôïÌïú ÎÇòÏπ®Î∞òÏù¥Ïïº`
      ] : [
        `The things you truly love - they are your direction`,
        `The moments you feel 'like yourself' - trust that feeling`,
        `The voice inside you - it's your most accurate compass`
      ];
      
      const twinResponses = isKorean ? [
        `ÎÑ§Í∞Ä Ïù¥ÎØ∏ ÏïåÍ≥† ÏûàÎäî ÎãµÏùÑ Ï∞æÍ≥† ÏûàÏñ¥. Ï°∞Í∏àÎßå Îçî ÏïàÏúºÎ°ú Îì§Ïñ¥Í∞ÄÎ¥ê.`,
        `ÏôÑÎ≤ΩÌïú ÏÑ†ÌÉùÏùÄ ÏóÜÏñ¥. ÎÑ§ ÎßàÏùåÏù¥ Í∞ÄÎäî Í≥≥Ïù¥ ÎãµÏù¥Ïïº.`,
        `ÎÑ§Í∞Ä Î≥¥Ïó¨Ï§Ä ÏãúÍ∑∏ÎÑêÎì§Ïù¥ Ïù¥ÎØ∏ ÎãµÏùÑ ÎßêÌïòÍ≥† ÏûàÏñ¥. Í∑∏Í≤ÉÎì§ÏùÑ ÎØøÏñ¥Î¥ê.`
      ] : [
        `You're finding the answer you already know. Go a little deeper inside.`,
        `There's no perfect choice. Where your heart goes is the answer.`,
        `The signals you've shown already speak the answer. Trust them.`
      ];
      
      const coreValues = isKorean ? [
        `ÏßÑÏ†ïÏÑ±Í≥º ÏûêÍ∏∞ ÌÉêÍµ¨`,
        `ÏÑ±Ïû•Í≥º ÏûêÍ∏∞ Î∞úÍ≤¨`,
        `ÎÇ¥Î©¥Ïùò Í∞ÄÏπòÏôÄ ÏûêÏú†`
      ] : [
        `Authenticity and Self-Exploration`,
        `Growth and Self-Discovery`,
        `Inner Values and Freedom`
      ];
      
      const decisionGuides = isKorean ? [
        {
          scenario: "ÏÑ†ÌÉùÏùò ÏàúÍ∞ÑÏù¥ ÏôîÏùÑ Îïå",
          advice: "ÎÑ§Í∞Ä Ï¢ãÏïÑÌïòÎäî Í≤É, ÎÑ§Í∞Ä 'ÎÇòÎãµÎã§'Í≥† ÎäêÎÅºÎäî Í≤ÉÏùÑ ÏÑ†ÌÉùÌï¥. Îã§Î•∏ ÏÇ¨ÎûåÏùò Í∏∞ÎåÄÎ≥¥Îã§ ÎÑ§ ÎßàÏùåÏùò Î™©ÏÜåÎ¶¨Î•º Îì§Ïñ¥Î¥ê."
        },
        {
          scenario: "ÏùòÏã¨Ïù¥ Îì§ Îïå",
          advice: "ÏôÑÎ≤ΩÌïú ÎãµÏùÑ Ï∞æÏúºÎ†§ ÌïòÏßÄ Îßà. ÎÑ§Í∞Ä ÏßÄÍ∏à Ïù¥ ÏàúÍ∞ÑÏóê ÏßÑÏã¨ÏúºÎ°ú ÏõêÌïòÎäî Í≤ÉÏù¥ Î¨¥ÏóáÏù∏ÏßÄ Î¨ºÏñ¥Î¥ê."
        },
        {
          scenario: "ÏïïÎ∞ïÏùÑ ÎäêÎÇÑ Îïå",
          advice: "ÎÑ§Í∞Ä Î≥¥Ïó¨Ï§Ä ÏãúÍ∑∏ÎÑêÎì§ÏùÑ Í∏∞ÏñµÌï¥. Í∑∏Í≤ÉÎì§Ïù¥ ÎÑ§ ÏßÑÏßú Í∞ÄÏπòÏïº. Í∑∏Í≤ÉÎì§ÏùÑ ÏßÄÌÇ§Îäî ÏÑ†ÌÉùÏùÑ Ìï¥."
        }
      ] : [
        {
          scenario: "When a moment of choice arrives",
          advice: "Choose what you love, what makes you feel 'like yourself'. Listen to your heart's voice over others' expectations."
        },
        {
          scenario: "When doubt arises",
          advice: "Don't try to find the perfect answer. Ask what you truly want in this moment."
        },
        {
          scenario: "When feeling pressure",
          advice: "Remember the signals you've shown. They are your true values. Make choices that honor them."
        }
      ];
      
      return JSON.stringify({
        profile: {
          archetype: archetype,
          operatingManual: operatingManuals[Math.floor(Math.random() * operatingManuals.length)],
          fearRadar: fearRadars[Math.floor(Math.random() * fearRadars.length)],
          innerCompass: innerCompasses[Math.floor(Math.random() * innerCompasses.length)],
          twinResponse: twinResponses[Math.floor(Math.random() * twinResponses.length)]
        },
        growth: {
          coreValues: coreValues[Math.floor(Math.random() * coreValues.length)],
          decisionGuide: decisionGuides
        }
      });
    };

    // --- TRANSLATIONS ---
    const i18n = {
      ko: {
        title: "ÎØ∏Îûò",
        onboarding_welcome: "ÎØ∏ÎûòÏóê Ïò® Í±∏ ÌôòÏòÅÌï¥ üëã",
        onboarding_sub: "ÎÇòÎ•º Ï¶ùÎ™ÖÌïòÍ∏∞Î≥¥Îã§, ÎÇòÎ•º Î∞úÍ≤¨ÌïòÎäî Ïó¨Ï†ï.",
        year_label: "ÌòÑÏû¨ ÌïôÎÖÑ",
        state_label: "ÏßÄÍ∏à ÎÑàÏùò ÎßàÏùåÏùÄ?",
        mood_label: "Ïò§ÎäòÏùò Í∞êÏ†ï Ïò®ÎèÑ",
        start_btn: "Í∏∞Î°ù ÏãúÏûëÌïòÍ∏∞",
        notebook_title: "ÏãúÍ∑∏ÎÑê ÎÖ∏Ìä∏",
        notebook_sub: "ÎÑ§Í∞Ä Î¨¥ÏóáÏùÑ Ìï† Îïå Í∞ÄÏû• 'ÎÇòÎãµÎã§'Í≥† ÎäêÎÅºÎäîÏßÄ Ï†ÅÏñ¥Ï§ò.",
        notebook_placeholder: "ÎÇòÎ•º Í∏∞ÏÅòÍ≤å ÌïòÎäî Í≤ÉÎì§...",
        chat_header: "ÏÑ±Ïû• Ïª¥Ìå®ÎãàÏñ∏",
        twin_btn: "Twin ÏÉùÏÑ±",
        private_badge: "Í∏∞Î°ùÏù¥ ÎÇ®ÏßÄ ÏïäÎäî ÏïàÏ†ÑÌïú ÎåÄÌôî",
        twin_title: "ÎÇòÏùò AI Twin",
        compass_tab: "ÏÑ±Ïû• ÎÇòÏπ®Î∞ò ‚ú®",
        profile_tab: "ÎÇòÏùò Í±∞Ïö∏",
        back_to_start: "ÏÑ∏ÏÖò Ï¢ÖÎ£å Î∞è Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú",
        operating_manual: "Ïö¥ÏòÅ Îß§Îâ¥Ïñº (Operating Manual)",
        fear_radar: "Î∂àÏïà Î†àÏù¥Îçî (Fear Radar)",
        inner_compass: "ÎÇ¥Î©¥ ÎÇòÏπ®Î∞ò (Inner Compass)",
        growth_title: "ÎÇòÏùò ÌïµÏã¨ Í∞ÄÏπò (Core Values)",
        decision_guide: "ÎÇòÎ•º ÏúÑÌïú Í≤∞Ï†ï Í∞ÄÏù¥Îìú",
        loading_twin: "ÎÑ§ ÏßÑÏã¨ÏùÑ Î∞îÌÉïÏúºÎ°ú ÏÑ±Ïû• ÎÇòÏπ®Î∞òÏùÑ ÎßåÎì§Í≥† ÏûàÏñ¥...",
        ai_typing: "ÎØ∏ÎûòÍ∞Ä ÎÑ§ ÏßÑÏã¨ÏùÑ Îì£Îäî Ï§ë..."
      },
      en: {
        title: "Mirae",
        onboarding_welcome: "Welcome to Mirae üëã",
        onboarding_sub: "A journey of self-discovery, not self-proof.",
        year_label: "Current Grade",
        state_label: "How is your heart today?",
        mood_label: "Emotional Temperature",
        start_btn: "Start Reflection",
        notebook_title: "Signal Notebook",
        notebook_sub: "Note down moments when you feel most 'like yourself'.",
        notebook_placeholder: "Things that bring me joy...",
        chat_header: "Growth Companion",
        twin_btn: "Generate Twin",
        private_badge: "Private & Anonymous Session",
        twin_title: "My AI Twin",
        compass_tab: "Growth Compass ‚ú®",
        profile_tab: "My Mirror",
        back_to_start: "End Session & Delete Data",
        operating_manual: "Operating Manual",
        fear_radar: "Fear Radar",
        inner_compass: "Inner Compass",
        growth_title: "Core Values",
        decision_guide: "Decision Guide for my Future",
        loading_twin: "Synthesizing your Twin and Growth Compass...",
        ai_typing: "Mirae is listening to your heart..."
      }
    };

    const STYLES = {
      card: "bg-white rounded-[2.5rem] shadow-xl p-8 border border-slate-100 transition-all duration-300",
      button: "px-6 py-4 rounded-2xl font-bold transition-all duration-200 active:scale-95 disabled:opacity-50",
      primaryBtn: "bg-indigo-600 text-white hover:bg-indigo-700 shadow-lg shadow-indigo-200",
      secondaryBtn: "bg-slate-100 text-slate-700 hover:bg-slate-200",
      input: "w-full p-4 rounded-2xl bg-slate-50 border-none focus:ring-2 focus:ring-indigo-400 outline-none transition-all placeholder:text-slate-300",
      pill: "px-4 py-2 rounded-full text-sm font-medium transition-colors",
    };

    function App() {
      const [lang, setLang] = useState('ko');
      const t = i18n[lang];

      const [stage, setStage] = useState('onboarding');
      const [context, setContext] = useState({ year: '', state: '', mood: 3, signals: [] });
      const [chatMessages, setChatMessages] = useState([]);
      const [isTyping, setIsTyping] = useState(false);
      const [isSynthesizing, setIsSynthesizing] = useState(false);
      const [twinPersona, setTwinPersona] = useState(null);
      const [activeTab, setActiveTab] = useState('profile');
      const scrollRef = useRef(null);
      const messagesContainerRef = useRef(null);
      const [newSignal, setNewSignal] = useState("");
      const hasAnimatedOnboardingRef = useRef(false);
      const hasAnimatedNotebookRef = useRef(false);

      // Track animation state - only animate once per stage
      useEffect(() => {
        if (stage === 'onboarding') {
          hasAnimatedOnboardingRef.current = true;
        }
      }, [stage]);

      // --- 1. ONBOARDING ---
      const Onboarding = () => {
        // Only animate on first render when stage is onboarding
        const shouldAnimate = stage === 'onboarding' && !hasAnimatedOnboardingRef.current;
        if (shouldAnimate) {
          hasAnimatedOnboardingRef.current = true;
        }
        return (
        <div className={`flex flex-col gap-8 max-w-md mx-auto ${shouldAnimate ? 'animate-in fade-in slide-in-from-bottom-4 duration-700' : ''}`}>
          <div className="text-center space-y-3">
            <h1 className="text-4xl font-black text-slate-900 tracking-tight">{t.onboarding_welcome}</h1>
            <p className="text-slate-500 font-medium">{t.onboarding_sub}</p>
          </div>
          <div className={STYLES.card}>
            <div className="space-y-8">
              <section>
                <label className="block text-xs font-black text-indigo-400 mb-4 uppercase tracking-[0.2em]">{t.year_label}</label>
                <div className="grid grid-cols-3 gap-3">
                  {['1', '2', '3'].map(y => (
                    <button 
                      key={y} 
                      onClick={() => setContext({...context, year: y})} 
                      className={`${STYLES.pill} h-12 flex items-center justify-center ${context.year === y ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-50 text-slate-500'}`}
                    >
                      {lang === 'ko' ? y+'ÌïôÎÖÑ' : 'G'+y}
                    </button>
                  ))}
                </div>
              </section>
              <section>
                <label className="block text-xs font-black text-indigo-400 mb-4 uppercase tracking-[0.2em]">{t.state_label}</label>
                <div className="flex flex-col gap-3">
                  {[
                    {id:'pre', label: lang === 'ko' ? 'üìö ÏÑ†ÌÉùÏùÑ ÏïûÎëêÍ≥† ÏûàÏñ¥' : 'üìö Before Decision'}, 
                    {id:'doubt', label: lang === 'ko' ? 'ü§î Ïù¥Í≤å ÎßûÎÇò Ïã∂Ïñ¥' : 'ü§î Doubting Path'}
                  ].map(s => (
                    <button 
                      key={s.id} 
                      onClick={() => setContext({...context, state: s.id})} 
                      className={`text-left p-5 rounded-2xl border-2 transition-all font-semibold ${context.state === s.id ? 'border-indigo-600 bg-indigo-50 text-indigo-700' : 'border-slate-50 bg-slate-50'}`}
                    >
                      {s.label}
                    </button>
                  ))}
                </div>
              </section>
              <button 
                disabled={!context.year} 
                onClick={() => setStage('notebook')} 
                className={`${STYLES.button} ${STYLES.primaryBtn} w-full flex items-center justify-center gap-2 group`}
              >
                {t.start_btn} 
                <Icon name="arrow-right" size={20} className="group-hover:translate-x-1 transition-transform" />
              </button>
            </div>
          </div>
        </div>
        );
      };

      // Track notebook animation state - only animate once per stage
      useEffect(() => {
        if (stage === 'notebook') {
          hasAnimatedNotebookRef.current = true;
        }
      }, [stage]);

      // --- 2. NOTEBOOK ---
      const NotebookView = () => {
        // Only animate on first render when stage is notebook
        const shouldAnimate = stage === 'notebook' && !hasAnimatedNotebookRef.current;
        if (shouldAnimate) {
          hasAnimatedNotebookRef.current = true;
        }
        
        // Memoize signals rendering to prevent re-render on input change
        const signalsList = useMemo(() => {
          return context.signals.map((s, i) => (
            <span 
              key={`signal-${i}-${s}`} 
              className="bg-white border border-slate-100 shadow-sm text-indigo-600 px-4 py-2 rounded-xl flex items-center gap-2 font-bold animate-in zoom-in-95"
            >
              {s} 
              <button 
                onClick={() => setContext(p => ({...p, signals: p.signals.filter((_, idx) => idx !== i)}))} 
                className="text-slate-300 hover:text-red-400"
              >
                <Icon name="x" size={14} />
              </button>
            </span>
          ));
        }, [context.signals]);
        
        // Memoize form submit handler - use functional update to avoid dependency on newSignal
        // This prevents re-renders on every keystroke that could cause focus issues
        const handleSubmit = useCallback((e) => {
          e.preventDefault();
          setNewSignal(currentValue => {
            const trimmed = currentValue.trim();
            if (trimmed) {
              setContext(prev => ({...prev, signals:[...prev.signals, trimmed]}));
            }
            return "";
          });
        }, []);
        
        // Input handler - stable callback that won't cause re-renders
        const inputRef = useRef(null);
        const handleInputChange = useCallback((e) => {
          setNewSignal(e.target.value);
        }, []);
        
        return (
        <div className={`flex flex-col gap-8 max-w-md mx-auto ${shouldAnimate ? 'animate-in fade-in slide-in-from-right-8 duration-500' : ''}`}>
          <div className="text-center space-y-3">
            <div className="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-[1.5rem] flex items-center justify-center mx-auto shadow-inner">
              <Icon name="book-open" size={28} />
            </div>
            <h2 className="text-3xl font-black text-slate-900">{t.notebook_title}</h2>
            <p className="text-slate-500 font-medium text-center">{t.notebook_sub}</p>
          </div>
          <div className={STYLES.card}>
            <form 
              onSubmit={handleSubmit} 
              className="flex gap-3 mb-8"
            >
              <input 
                ref={inputRef}
                value={newSignal} 
                onChange={handleInputChange} 
                placeholder={t.notebook_placeholder} 
                className={STYLES.input} 
              />
              <button type="submit" className="bg-indigo-600 text-white p-4 rounded-2xl">
                <Icon name="plus" size={24} />
              </button>
            </form>
            <div className="flex flex-wrap gap-2 min-h-[140px] items-start content-start bg-slate-50/50 p-4 rounded-3xl border border-dashed border-slate-200">
              {signalsList}
            </div>
            <button 
              onClick={() => setStage('chat')} 
              className={`${STYLES.button} ${STYLES.primaryBtn} w-full mt-8`}
            >
              {t.start_btn}
            </button>
          </div>
        </div>
        );
      };

      // --- 3. CHAT ---
      useEffect(() => {
        const initChat = async () => {
          if (stage === 'chat' && chatMessages.length === 0) {
            setIsTyping(true);
            const res = await simulateResponse(context, [], "", lang);
            setChatMessages([{ role: 'ai', text: res }]);
            setIsTyping(false);
          }
        };
        initChat();
      }, [stage]);

      // Auto-scroll to bottom when messages change (but not during typing)
      useEffect(() => {
        if (stage === 'chat' && messagesContainerRef.current && scrollRef.current) {
          // Only scroll if user is near the bottom (within 100px)
          const container = messagesContainerRef.current;
          const isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 100;
          
          if (isNearBottom || chatMessages.length === 0) {
            // Use requestAnimationFrame to ensure DOM is updated
            requestAnimationFrame(() => {
              if (scrollRef.current) {
                scrollRef.current.scrollIntoView({ behavior: 'smooth', block: 'end' });
              }
            });
          }
        }
      }, [chatMessages, isTyping, stage]);

      const handleSendMessage = async (e) => {
        e.preventDefault();
        const text = e.target.msg.value;
        if (!text || isTyping) return;
        const newMsgs = [...chatMessages, { role: 'user', text }];
        setChatMessages(newMsgs);
        e.target.reset();
        setIsTyping(true);
        const res = await simulateResponse(context, chatMessages, text, lang);
        setChatMessages(prev => [...prev, { role: 'ai', text: res }]);
        setIsTyping(false);
      };

      const ChatView = () => (
        <div className="flex flex-col h-[78vh] max-w-xl mx-auto bg-white rounded-[3rem] shadow-2xl overflow-hidden border border-slate-100">
          <div className="p-6 border-b flex items-center justify-between bg-slate-50/50">
            <div className="flex items-center gap-4">
              <div className="w-12 h-12 rounded-2xl bg-indigo-600 flex items-center justify-center text-white shadow-lg">
                <Icon name="sparkles" size={24} />
              </div>
              <div>
                <h3 className="font-black text-slate-900">{t.title}</h3>
                <span className="text-[10px] uppercase font-black text-indigo-500 tracking-widest">{t.chat_header}</span>
              </div>
            </div>
            <button 
              onClick={generateTwin} 
              className="text-sm font-black text-indigo-600 px-5 py-2.5 hover:bg-indigo-50 rounded-2xl transition-all"
            >
              {t.twin_btn}
            </button>
          </div>
          <div ref={messagesContainerRef} className="flex-1 overflow-y-auto p-8 space-y-6 chat-messages-container">
            {chatMessages.map((m, i) => (
              <div 
                key={i} 
                className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'} animate-in fade-in slide-in-from-bottom-2`}
              >
                <div className={`max-w-[85%] p-5 rounded-[2rem] font-medium leading-relaxed ${m.role === 'user' ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-slate-100 text-slate-800 rounded-tl-none'}`}>
                  {m.text}
                </div>
              </div>
            ))}
            {isTyping && (
              <div className="text-slate-400 text-xs font-bold italic animate-pulse flex items-center gap-2">
                <Icon name="sparkles" size={12} /> {t.ai_typing}
              </div>
            )}
            <div ref={scrollRef} />
          </div>
          <form onSubmit={handleSendMessage} className="p-6 bg-slate-50 border-t flex gap-3 chat-input-container">
            <input 
              name="msg" 
              placeholder={t.notebook_placeholder} 
              className={STYLES.input} 
              autoComplete="off"
              onFocus={(e) => {
                // Prevent browser from auto-scrolling when input is focused
                const container = messagesContainerRef.current;
                if (container) {
                  const currentScroll = container.scrollTop;
                  // Reset scroll position immediately to prevent jump
                  requestAnimationFrame(() => {
                    if (container) {
                      container.scrollTop = currentScroll;
                    }
                  });
                }
              }}
            />
            <button type="submit" className="bg-indigo-600 text-white p-5 rounded-2xl shadow-xl">
              <Icon name="arrow-right" size={24} />
            </button>
          </form>
        </div>
      );

      // --- 4. TWIN VIEW ---
      const generateTwin = async () => {
        setStage('twin');
        setIsSynthesizing(true);
        const res = await simulateTwin(context, chatMessages, lang);
       
        try {
          const parsed = JSON.parse(res);
          setTwinPersona(parsed);
        } catch(e) {
          console.error("Parse Fail:", e);
          // Fallback data in case of malformed response
          const isKorean = lang === 'ko';
          setTwinPersona({
            profile: { 
              archetype: isKorean ? "ÌÉêÍµ¨ÌïòÎäî Î≥Ñ" : "Thinking Star", 
              operatingManual: isKorean ? "ÏÑ±Ïû•ÏùÑ ÏúÑÌïú ÏÑ±Ï∞∞Ï†Å Ï†ëÍ∑º." : "Reflective approach to growth.", 
              fearRadar: isKorean ? "ÎØ∏Îûò Í≤ΩÎ°úÏóê ÎåÄÌïú Î∂àÏïà." : "Anxiety about future path.", 
              innerCompass: isKorean ? "Í∞úÏù∏Ï†Å Ï†ïÎ†¨ÏùÑ Ï∞æÎäî Ï§ë." : "Seeking personal alignment.", 
              twinResponse: isKorean ? "Í≥ÑÏÜç ÏïàÏúºÎ°ú Îì§Ïñ¥Í∞ÄÎ¥ê." : "Keep looking inward." 
            },
            growth: { 
              coreValues: isKorean ? "ÏßÑÏ†ïÏÑ±Í≥º ÌÉêÍµ¨" : "Integrity & Exploration", 
              decisionGuide: [] 
            }
          });
        }
        setIsSynthesizing(false);
      };

      const TwinView = () => (
        <div className="max-w-xl mx-auto space-y-8 animate-in fade-in zoom-in-95 duration-700">
          <div className="text-center space-y-4">
            <div className="w-24 h-24 bg-gradient-to-tr from-indigo-500 to-purple-500 rounded-[2.5rem] flex items-center justify-center text-white mx-auto shadow-2xl animate-pulse">
              <Icon name="fingerprint" size={48} />
            </div>
            <h2 className="text-3xl font-black text-slate-900">
              {t.twin_title} : {twinPersona?.profile.archetype || "..."}
            </h2>
            <div className="flex gap-2 justify-center">
              <button 
                onClick={() => setActiveTab('profile')} 
                className={`px-4 py-2 rounded-xl text-sm font-black transition-all ${activeTab === 'profile' ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-500'}`}
              >
                {t.profile_tab}
              </button>
              <button 
                onClick={() => setActiveTab('compass')} 
                className={`px-4 py-2 rounded-xl text-sm font-black transition-all ${activeTab === 'compass' ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-500'}`}
              >
                {t.compass_tab}
              </button>
            </div>
          </div>

          {isSynthesizing ? (
            <div className={`${STYLES.card} flex flex-col items-center justify-center py-20 gap-4`}>
              <Icon name="loader-2" size={40} className="animate-spin text-indigo-600" />
              <p className="font-bold text-slate-500">{t.loading_twin}</p>
            </div>
          ) : (
            <div className="space-y-6">
              {activeTab === 'profile' ? (
                <div className="space-y-6 animate-in fade-in slide-in-from-left-4">
                  <div className={STYLES.card}>
                    <div className="flex items-center gap-3 mb-6 pb-4 border-b">
                      <Icon name="anchor" size={24} className="text-indigo-500" />
                      <h4 className="font-black text-slate-800">{t.operating_manual}</h4>
                    </div>
                    <p className="text-slate-600 font-medium italic">"{twinPersona?.profile.operatingManual}"</p>
                  </div>
                  <div className="grid grid-cols-2 gap-4">
                    <div className={`${STYLES.card} p-6`}>
                      <h4 className="text-[10px] font-black uppercase text-red-500 mb-2">{t.fear_radar}</h4>
                      <p className="text-sm font-bold text-slate-700">{twinPersona?.profile.fearRadar}</p>
                    </div>
                    <div className={`${STYLES.card} p-6`}>
                      <h4 className="text-[10px] font-black uppercase text-indigo-500 mb-2">{t.inner_compass}</h4>
                      <p className="text-sm font-bold text-slate-700">{twinPersona?.profile.innerCompass}</p>
                    </div>
                  </div>
                  <div className="bg-slate-900 text-white rounded-[3rem] p-8 shadow-2xl space-y-4">
                    <div className="flex items-center gap-3 opacity-60">
                      <Icon name="message-circle" size={18} />
                      <span className="text-[10px] font-black uppercase tracking-widest">Twin's Whisper</span>
                    </div>
                    <p className="text-xl font-bold leading-relaxed italic">"{twinPersona?.profile.twinResponse}"</p>
                  </div>
                </div>
              ) : (
                <div className="space-y-6 animate-in fade-in slide-in-from-right-4">
                  <div className={STYLES.card}>
                    <h4 className="font-black text-amber-500 mb-4">{t.growth_title}</h4>
                    <p className="text-indigo-900 font-bold text-xl">{twinPersona?.growth.coreValues}</p>
                  </div>
                  {twinPersona?.growth.decisionGuide?.map((item, i) => (
                    <div key={i} className={`${STYLES.card} p-6 hover:border-indigo-200`}>
                      <span className="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-lg text-[10px] font-black mb-2 block w-fit">
                        {item.scenario}
                      </span>
                      <p className="text-sm text-slate-600 font-medium">{item.advice}</p>
                    </div>
                  ))}
                  <div className="p-6 bg-amber-50 rounded-3xl border border-amber-100 flex gap-4 items-start">
                    <Icon name="lightbulb" size={20} className="text-amber-500 mt-1" />
                    <p className="text-xs text-amber-800 leading-relaxed italic">
                      <strong>Growth Tip:</strong> Use these criteria to guide your next decision. Being a "better person" starts with choosing what you truly love.
                    </p>
                  </div>
                </div>
              )}
              <button 
                onClick={() => window.location.reload()} 
                className={`${STYLES.button} ${STYLES.secondaryBtn} w-full mt-4`}
              >
                {t.back_to_start}
              </button>
            </div>
          )}
        </div>
      );

      return (
        <div className="min-h-screen bg-[#FDFDFF] text-slate-900 font-sans p-6 selection:bg-indigo-100">
          <header className="max-w-xl mx-auto flex items-center justify-between mb-10">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-2xl bg-indigo-600 flex items-center justify-center text-white shadow-lg">
                <Icon name="sparkles" size={20} />
              </div>
              <span className="font-black text-2xl tracking-tighter text-slate-900">{t.title}</span>
            </div>
            <div className="flex items-center gap-4">
              <button 
                onClick={() => setLang(lang === 'ko' ? 'en' : 'ko')} 
                className="bg-white border px-4 py-2 rounded-2xl text-[10px] font-black text-indigo-600 shadow-sm flex items-center gap-2 hover:bg-slate-50 transition-colors"
              >
                <Icon name="globe" size={12} /> {lang === 'ko' ? 'English' : 'ÌïúÍµ≠Ïñ¥'}
              </button>
              <div className="text-[10px] font-black text-slate-400">
                <Icon name="eye-off" size={12} className="inline mr-1 text-indigo-400" /> {t.private_badge}
              </div>
            </div>
          </header>
          <main className="pb-12">
            {stage === 'onboarding' && <Onboarding />}
            {stage === 'notebook' && <NotebookView />}
            {stage === 'chat' && <ChatView />}
            {stage === 'twin' && <TwinView />}
          </main>
          
          {/* Aesthetic Blurs */}
          <div className="fixed -bottom-48 -left-48 w-96 h-96 bg-indigo-200 rounded-full blur-[100px] opacity-20 -z-10 animate-pulse"></div>
          <div className="fixed -top-48 -right-48 w-96 h-96 bg-purple-200 rounded-full blur-[100px] opacity-20 -z-10"></div>
        </div>
      );
    }

    // Render the app
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>